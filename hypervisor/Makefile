#
# Jailhouse, a Linux-based partitioning hypervisor
#
# Copyright (c) Siemens AG, 2013
# Copyright (c) Valentine Sinitsyn, 2014
#
# Authors:
#  Jan Kiszka <jan.kiszka@siemens.com>
#  Valentine Sinitsyn <valentine.sinitsyn@gmail.com>
#
# This work is licensed under the terms of the GNU GPL, version 2.  See
# the COPYING file in the top-level directory.
#

LINUXINCLUDE := -I$(src)/arch/$(SRCARCH)/include -I$(src)/include
KBUILD_CFLAGS := -g -Os -Wall -Wstrict-prototypes -Wtype-limits \
		 -Wmissing-declarations -Wmissing-prototypes \
		 -fno-strict-aliasing -fno-pic -fno-common \
		 -fno-stack-protector -fno-builtin-ffsl

ifeq ($(SRCARCH),x86)
KBUILD_CFLAGS += -mcmodel=kernel
KBUILD_CPPFLAGS += -m64
BUILD_VARIANTS := amd intel
endif

ifneq ($(wildcard $(obj)/include/jailhouse/config.h),)
KBUILD_CFLAGS += -include $(obj)/include/jailhouse/config.h
endif

define filechk_version
	$(src)/../scripts/gen_version_h $(src)/..
endef

clean-files := $(obj)/include/jailhouse/version.h

$(obj)/include/jailhouse/version.h: $(src)/Makefile FORCE
	$(call filechk,version)

$(obj)/setup.o: $(obj)/include/jailhouse/version.h

arch-builtin: FORCE
	$(Q)$(MAKE) $(build)=$(obj)/arch/$(SRCARCH)

always :=

define BUILD_JAILHOUSE_template
always += jailhouse$(1).bin

hypervisor$(1)-y := setup.o printk.o paging.o control.o lib.o \
	arch/$$(SRCARCH)/built-in$(1).o hypervisor.lds
targets += $$(hypervisor$(1)-y)

# Need fake recipe here so make will consider this a volatile target
$$(obj)/arch/$$(SRCARCH)/built-in$(1).o: arch-builtin
	@

HYPERVISOR$(1)_OBJS = $$(addprefix $$(obj)/,$$(hypervisor$(1)-y))

LDFLAGS_hypervisor$(1).o := -T

targets += hypervisor$(1).o
$$(obj)/hypervisor$(1).o: $$(src)/hypervisor.lds $$(HYPERVISOR$(1)_OBJS)
	$$(call if_changed,ld)

OBJCOPYFLAGS_jailhouse$(1).bin := -O binary -R .eh_frame

targets += jailhouse$(1).bin
$$(obj)/jailhouse$(1).bin: $$(obj)/hypervisor$(1).o
	$$(call if_changed,objcopy)
endef

ifneq ($(BUILD_VARIANTS),)
$(foreach variant,$(BUILD_VARIANTS),\
	$(eval $(call BUILD_JAILHOUSE_template,-$(variant))))
else
$(eval $(call BUILD_JAILHOUSE_template,))
endif

.PHONY: arch-builtin
